<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Audio Diary</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <a class="brand" href="/">
          <span class="logo">AD</span>
          <h1>Audio Diary</h1>
        </a>
        <div class="right subtle">上传音频，自动转写与总结</div>
      </div>
    </header>

    <div class="container">
      <section class="upload">
        <div class="card">
          <h2 class="section-title">上传音频</h2>
          <div class="subtle">支持 wav / mp3 / m4a / aac / flac / ogg</div>
          <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="space-top">
            <label class="dropzone" id="dropzone">
              <input type="file" name="file" accept="audio/*" required id="fileInput" />
              <div>拖拽音频到此处或点击选择文件</div>
              <div class="hint">建议清晰人声，效果更好</div>
              <div id="fileName" class="subtle space-top">未选择文件</div>
            </label>
            <div class="flex space-top">
              <button class="button" type="submit" id="submitBtn" disabled>上传并处理</button>
              <button class="button secondary" type="button" id="clearBtn">清除选择</button>
            </div>
            <div id="statusMsg" class="subtle space-top" style="display:none;">正在上传并处理，请稍候…</div>
          </form>
        </div>
      </section>

      <section class="list table-wrap">
        <div class="card">
          <h2 class="section-title">历史记录</h2>
          <table>
            <thead>
              <tr>
                <th class="table-time">时间</th>
                <th class="table-filename">文件名</th>
                <th class="table-status">状态</th>
                <th class="table-actions">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for r in records %}
              <tr>
                <td class="table-time"><span class="subtle">{{ r.created_at_str }}</span></td>
                <td class="table-filename"><span class="ellipsis" title="{{ r.display_filename }}">{{ r.display_filename }}</span></td>
                <td class="table-status">
                  {# 统一状态列：以任务状态为主，done 时结合文件存在性展示更直观的结果 #}
                  {% set st = r.task_state %}
                  {% if st == 'done' %}
                    {% if r.has_transcript and r.has_summary %}
                      <span class="badge success task-badge" data-rid="{{ r.id }}" data-state="done">已完成</span>
                    {% elif r.has_transcript %}
                      <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="done">已转写</span>
                    {% else %}
                      <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="done">已完成</span>
                    {% endif %}
                  {% elif st == 'error' %}
                    <span class="badge danger task-badge" data-rid="{{ r.id }}" data-state="error">失败</span>
                  {% elif st == 'queued' %}
                    <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="queued">排队中</span>
                  {% elif st == 'transcribing' %}
                    <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="transcribing">转写中</span>
                  {% elif st == 'summarizing' %}
                    <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="summarizing">总结中</span>
                  {% elif st == 'running' %}
                    <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="running">处理中</span>
                  {% else %}
                    <span class="badge muted task-badge" data-rid="{{ r.id }}" data-state="{{ st }}">未开始</span>
                  {% endif %}
                </td>
                <td class="table-actions">
                  <div class="flex">
                    <a class="icon-btn primary" href="/detail/{{ r.id }}" title="详情" aria-label="详情">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                    <form action="/delete/{{ r.id }}" method="post" onsubmit="return confirm('确认删除该记录以及所有相关文件？');" style="display:inline;">
                      <button class="icon-btn danger" type="submit" title="删除" aria-label="删除">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M6 6l1 16h10l1-16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      const fileInput = document.getElementById('fileInput');
      const fileName = document.getElementById('fileName');
      const submitBtn = document.getElementById('submitBtn');
      const statusMsg = document.getElementById('statusMsg');
      const uploadForm = document.getElementById('uploadForm');
      const dropzone = document.getElementById('dropzone');
      const clearBtn = document.getElementById('clearBtn');

      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length > 0) {
          fileName.textContent = fileInput.files[0].name;
          submitBtn.disabled = false;
        } else {
          fileName.textContent = '未选择文件';
          submitBtn.disabled = true;
        }
      });

      uploadForm.addEventListener('submit', () => {
        submitBtn.disabled = true;
        submitBtn.textContent = '处理中…';
        statusMsg.style.display = 'block';
      });

      dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.borderColor = '#94a3b8'; });
      dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = '#cbd5e1'; });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          const evt = new Event('change');
          fileInput.dispatchEvent(evt);
        }
      });

      clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        fileName.textContent = '未选择文件';
        submitBtn.disabled = true;
      });

      // ---- task status polling for history list ----
      function applyTaskBadgeStyle(el, state) {
        el.classList.remove('success');
        el.classList.remove('danger');
        el.classList.remove('muted');
        if (state === 'done') {
          el.classList.add('success');
        } else if (state === 'error') {
          el.classList.add('danger');
        } else {
          el.classList.add('muted');
        }
      }

      const badges = Array.from(document.querySelectorAll('.task-badge'));
      badges.forEach((el) => {
        const st = el.getAttribute('data-state') || 'idle';
        el.textContent = st;
        applyTaskBadgeStyle(el, st);
      });

      async function pollOne(el) {
        const rid = el.getAttribute('data-rid');
        if (!rid) return;
        try {
          const res = await fetch(`/status/${rid}`, { cache: 'no-store' });
          if (!res.ok) return;
          const s = await res.json();
          const st = s.state || 'idle';
          el.setAttribute('data-state', st);
          el.textContent = st;
          applyTaskBadgeStyle(el, st);
        } catch (e) {
          // ignore
        }
      }

      // 仅轮询非 done 的任务
      const needPoll = badges.filter((el) => {
        const st = el.getAttribute('data-state') || 'idle';
        return st !== 'done';
      });

      if (needPoll.length > 0) {
        setInterval(() => {
          needPoll.forEach(pollOne);
        }, 2000);
      }
    </script>
  </body>
</html>
